# Phase 5 — Core Application Layer (архитектурная подготовка)

Документ фиксирует решения, принятые при подготовке к будущей загрузке мира (chunk-based, addressables). Геймплей и поведение не менялись — только комментарии и точки расширения.

---

## 1. GameRoot — Composition Root

- **GameRoot** — единственная точка входа (Composition Root): собирает bootstrap, tick loop, meta, state machine.
- Геймплейная логика в нём **не живёт** — только создание и связывание систем.
- Зарезервированы точки расширения (private-поля + protected-сеттеры) под будущие системы:
  - **WorldRuntime** — runtime-представление загруженного мира (чанки, не сцены).
  - **ChunkStreamer** — подгрузка/выгрузка addressable-чанков по позиции игрока.
  - **PlayerRuntime** — сущность игрока и позиция; драйвер стриминга чанков.
- Сами системы **пока не добавлены** — только заглушки для будущей подстановки.

---

## 2. LoadLocationState — единственная точка загрузки мира

- Загрузка игрового мира выполняется **только** в **LoadLocationState**. Никакой другой стейт не должен грузить мир.
- В будущем:
  - **BeginLoadLocation(nodeId)** — старт загрузки контента по nodeId (addressable-чанки и т.п.); мир не на сценах, а чанки в текущей сцене.
  - **CompleteLoadLocation()** — вызывается по завершении загрузки; переход в RunLocation, спавн игрока и т.д.
- Сейчас оба метода — **пустые хуки** с TODO в коде; в Enter по-прежнему только логирование.

---

## 3. WorldGraph — без сцен и чанков

- **WorldGraphData** / **WorldGraphRuntime** / **WorldNodeData** не зависят от:
  - Unity-сцен,
  - чанков,
  - prefab'ов,
  - Addressables.
- Содержат только данные и логику графа (узлы, рёбра, достижимость).
- **nodeId** — логический ключ; в будущем по нему будет определяться, какой world-content (набор чанков) грузить. В графе нет ссылок на этот контент.

---

## 4. MetaContext — чисто данные

- **MetaContext** — только персистентные данные (прогресс, экономика, хаб, анлоки, текущий узел мира).
- Правила:
  - без ссылок на UnityEngine;
  - без сцен;
  - без runtime-объектов (GameObject, MonoBehaviour).
- Сериализуется в JSON, сохраняется/загружается через SaveService. Безопасно передавать между слоями.

---

## 5. Что намеренно не делали

- Не добавляли Addressables.
- Не добавляли чанки и стриминг.
- Не добавляли новые стейты и новые системы.
- Не меняли публичное поведение и существующую логику.

---

## 6. Итог

После Phase 5:

- проект компилируется и работает как раньше;
- код явно подготовлен к:
  - chunk-based миру,
  - addressable-стримингу,
  - большой карте без сцен для мира;
- LoadLocationState зафиксирован как **единственная** точка загрузки мира;
- границы слоёв и правила (Composition Root, pure data, graph без сцен) описаны в комментариях в коде и в этом MD.
